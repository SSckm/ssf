function insertBlogList(msg) {
	var blogArray = msg.list
	if (blogArray == null || blogArray.length == 0) {
		return;
	}
	for (var i = 0; i < blogArray.length; i++) {
		var authId = blogArray[i].createUserId
		var blogName = blogArray[i].title
		var blogKey = blogArray[i].htmlFileId
		$("#lastBlogList")
				.append(
						"<div class=\"margin-top-20 profile-desc-link\"><a href=\"http://blog.soaer.com/"
								+ authId
								+ "/"
								+ blogKey
								+ ".html"
								+ "\">"
								+ blogName + "</a></div>");
	}
}

function insertCommentsList(msg) {
	var commentsArray = msg.list
	if (commentsArray == null || commentsArray.length == 0) {
		return;
	}

	for (var i = 0; i < commentsArray.length; i++) {
		var content = commentsArray[i].content
		var date = commentsArray[i].createDate
		var name = commentsArray[i].author
		var dateStmp = new Date(date);
		var year = dateStmp.getFullYear();
		var month = dateStmp.getMonth() + 1;
		var day = dateStmp.getDate();

		$("#commentsList")
				.append(
						"<li class=\"media\"><div class=\"media-body todo-comment\"><p class=\"todo-comment-head\"><span class=\"todo-comment-username\">"
								+ name
								+ " </span>&nbsp; <span class=\"todo-comment-date\">"
								+ year + "年" + month + "月" + day + "日"
								+ "</span></p><p class=\"todo-text-color\">"
								+ content + "</p></div></li>");
	}
}


function gbl() {
	$.ajax({
		type : "POST",
		url : "http://blog.soaer.com/gbl",
		data : "pageNumber=1",
		success : function(msg) {
			if (msg.code == 1) {
				insertBlogList(msg);
			}
		}
	});
}

function gcl() {
	$.ajax({
		type : "POST",
		url : "http://blog.soaer.com/gcl",
		data : "pageNumber=1&pageSize=10&blogId=" + blogId,
		success : function(msg) {
			if (msg.code == 1) {
				insertCommentsList(msg);
			}
		}
	});
}

function sm() {
	var content = $('#sendMailContent').val()
	var reg = new RegExp("^[a-z0-9]+([._\\-]*[a-z0-9])*@([a-z0-9]+[-a-z0-9]*[a-z0-9]+.){1,63}[a-z0-9]+$");
	if (!reg.test(content)) {
		$("#sendEmailErrorMessage").html("<font color=\"#FF0000\">" + "邮箱格式错误！" + "</font> ")
		return;
	}
	var obj = $('#sendEmail').serialize();
	$.ajax({
		type : "POST",
		url : "http://blog.soaer.com/sm",
		data : obj,
		success : function(msg) {
			if (msg.code == 1) {
				$("#sendEmailErrorMessage").html("<font color=\"#FF0000\">" + "发送邮件成功，请查看邮箱" + "</font> ")
			} else {
				$("#sendEmailErrorMessage").html("<font color=\"#FF0000\">" + msg.error + "</font> ")
			}
		}
	});
}

function setCommentsName() {
	var cName = $.cookie('cidA');
	$.base64.utf8decode = true;
    if (cName == "" || cName == null) {
    	$("#commentsName").text("匿名")
    	return;
    }
    var after=$.base64.atob(cName) 
    $("#commentsName").text(after)
}

function vm() {
	var obj = $('#validationEmail').serialize();
	$.ajax({
		type : "POST",
		url : "http://blog.soaer.com/vm",
		data : obj,
		success : function(msg) {
			if (msg.code == 1) {
				$("#sendEmail").hide()
				$("#validationEmail").hide()
				$("#validationEmailErrorMessage").html("")
				setCommentsName();
				alert("验证成功，可以评论，清空浏览器缓存需要重新验证")
			} else {
				$("#validationEmailErrorMessage").html("<font color=\"#FF0000\">" + msg.error + "</font> ")
			}
		}
	});
}

function ac() {
	var cid = $.cookie('cid');
	if (cid == null) {
		$("#sendEmail").show()
		$("#validationEmail").show()
		$("#sendEmailErrorMessage").html("")
		$("#validationEmailErrorMessage").html("<font color=\"#FF0000\">" + "请先验证邮箱" + "</font> ")
		return;
	}

	var content = $('#commentsContent').val()
	if (content == "" || content == null) {
		$("#sendCommentsErrorMessage").html("<font color=\"#FF0000\">" + "评论不能为空" + "</font> ")
		return;
	}

	if (content.length >= 120) {
		$("#sendCommentsErrorMessage").html("<font color=\"#FF0000\">" + "评论内容过长" + "</font> ")
		return;
	}

	var obj = $('#addComments').serialize();
	$.ajax({
		type : "POST",
		url : "http://blog.soaer.com/ac",
		data : obj + "&blogId=" + blogId,
		success : function(msg) {
			if (msg.code == 1) {
				$('#commentsContent').val("");
				var msg = new Object();
				msg.content = content

				var cName = $.cookie('cidA');
				$.base64.utf8decode = true;
    			if (cName == "" || cName == null) {
    				cName = "匿名"
    			} else {
    				cName = $.base64.atob(cName) 
    			}
    			msg.author = cName
    			var myDate = new Date();
    			msg.createDate = myDate.getTime();

    			var mycars = new Array()
    			mycars[0] = msg

    			var c = new Object();
    			c.list = mycars
    			insertCommentsList(c)
			} else {
				$("#sendCommentsErrorMessage").html("<font color=\"#FF0000\">" + msg.error + "</font> ")
			}
		}
	});
}

function addImgAutoWidth() {
	$('.page-content').find('img').each(function(){
		$(this).attr('class',"img-auto-width"); 
	});
}

function ccl() {
	$.ajax({
		type : "GET",
		url : "http://blog.soaer.com/clog?" + "blogId=" + blogId + "&blogKey=" + blogKey,
		success : function(msg) {
		}
	});
}
addImgAutoWidth()
gbl();
gcl();
setCommentsName();
ccl()

$(document).ready(function(){
  $("#sdm").click(function(){
    sm();
  });
  $("#ac").click(function(){
    ac();
  });
  $("#vm").click(function(){
    vm();
  });
});